<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
  
  

  


  <head>
    <title>
      #25475 (Database function strftime with argument %W fails in 1.9a1)
     – Django
    </title>
      <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
      <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!--[if IE]><script type="text/javascript">
      if (/^#__msie303:/.test(window.location.hash))
        window.location.replace(window.location.hash.replace(/^#__msie303:/, '#'));
    </script><![endif]-->
        <link rel="search" href="/search" />
        <link rel="prev" href="/ticket/25474" title="Ticket #25474" />
        <link rel="last" href="/ticket/26358" title="Ticket #26358" />
        <link rel="help" href="/wiki/TracGuide" />
        <link rel="alternate" href="/ticket/25475?format=csv" type="text/csv" class="csv" title="Comma-delimited Text" /><link rel="alternate" href="/ticket/25475?format=tab" type="text/tab-separated-values" class="tab" title="Tab-delimited Text" /><link rel="alternate" href="/ticket/25475?format=rss" type="application/rss+xml" class="rss" title="RSS Feed" />
        <link rel="next" href="/ticket/25476" title="Ticket #25476" />
        <link rel="start" href="/wiki" />
        <link rel="stylesheet" href="/chrome/common/css/trac.css" type="text/css" /><link rel="stylesheet" href="/chrome/common/css/ticket.css" type="text/css" />
        <link rel="first" href="/ticket/1" title="Ticket #1" />
        <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon" />
        <link rel="icon" href="/favicon.ico" type="image/x-icon" />
    <style id="trac-noscript" type="text/css">.trac-noscript { display: none !important }</style>
      <link type="application/opensearchdescription+xml" rel="search" href="/search/opensearch" title="Search Django" />
    <script type="text/javascript">
      var auto_preview_timeout=2.0;
      var form_token="c194439d9bc0beebf8673bad";
      var comments_prefs={"comments_only":"false","comments_order":"oldest"};
    </script>
      <script type="text/javascript" charset="utf-8" src="/chrome/common/js/jquery.js"></script>
      <script type="text/javascript" charset="utf-8" src="/chrome/common/js/babel.js"></script>
      <script type="text/javascript" charset="utf-8" src="/chrome/common/js/trac.js"></script>
      <script type="text/javascript" charset="utf-8" src="/chrome/common/js/search.js"></script>
      <script type="text/javascript" charset="utf-8" src="/chrome/common/js/folding.js"></script>
      <script type="text/javascript" charset="utf-8" src="/chrome/common/js/wikitoolbar.js"></script>
      <script type="text/javascript" charset="utf-8" src="/chrome/common/js/resizer.js"></script>
      <script type="text/javascript" charset="utf-8" src="/chrome/common/js/auto_preview.js"></script>
    <script type="text/javascript">
      jQuery("#trac-noscript").remove();
      jQuery(document).ready(function($) {
        $(".trac-autofocus").focus();
        $(".trac-target-new").attr("target", "_blank");
        setTimeout(function() { $(".trac-scroll").scrollToTop() }, 1);
        $(".trac-disable-on-submit").disableOnSubmit();
      });
    </script>
    <script type="text/javascript" src="/chrome/common/js/threaded_comments.js"></script>
    <script type="text/javascript">
      jQuery(document).ready(function($) {
        $("div.description").find("h1,h2,h3,h4,h5,h6").addAnchor(_("Link to this section"));
        $(".foldable").enableFolding(false, true);
      /*<![CDATA[*/
        $("#attachments").toggleClass("collapsed");
        $("#trac-up-attachments").click(function () {
          $("#attachments").removeClass("collapsed");
          return true;
        });
        $("#modify").parent().toggleClass("collapsed");
        $(".trac-topnav a").click(function() { $("#modify").parent().removeClass("collapsed"); });
        /* only enable control elements for the currently selected action */
        var actions = $("#action input[name='action']");
        function updateActionFields() {
          actions.each(function () {
            $(this).siblings().find("*[id]").enable($(this).checked());
            $(this).siblings().filter("*[id]").enable($(this).checked());
          });
        }
        actions.click(updateActionFields);
        updateActionFields();
        function setRevertHandler() {
          $("button.trac-revert").click(function() {
            var div = $("div", this);
            var field_name = div[0].id.substr(7);
            var field_value = div.text();
            var input = $("#propertyform *[name=field_" + field_name + "]");
            if (input.length > 0) {
              if (input.filter("input[type=radio]").length > 0) {
                input.val([field_value]);
              } else if (input.filter("input[type=checkbox]").length > 0) {
                input.val(field_value == "1" ? [field_value] : []);
              } else {
                input.val(field_value);
              }
            } else { // Special case for CC checkbox
              input = $("#propertyform input[name=cc_update]").val([]);
            }
            input.change();
            $(this).closest("li").remove();
            return false;
          });
        }
        setRevertHandler();
        var comment_focused = false;
        $("#comment").focus(function() { comment_focused = true; })
                     .blur(function() { comment_focused = false; });
        $("#propertyform").autoSubmit({preview: '1'}, function(data, reply) {
          var items = $(reply);
          // Update ticket box
          $("#ticket").replaceWith(items.filter('#ticket'));
          // Unthread, unrevert and update changelog
          if (!$('#trac-comments-oldest').checked())
            $('#trac-comments-oldest').click().change();
          $("#changelog").replaceWith(items.filter("#changelog"));
          if ($('#trac-comments-only-toggle').attr('checked'))
            $('#trac-comments-only-toggle').click().attr('checked', true);
          // Show warning
          var new_changes = $("#changelog .trac-new");
          $("#trac-edit-warning").toggle(new_changes.length != 0);
          if (new_changes.length != 0)
            $("#changelog").parent().show().removeClass("collapsed");
          // Update view time
          $("#propertyform input[name='view_time']").replaceWith(items.filter("input[name='view_time']"));
          // Update preview
          var preview = $("#ticketchange").html(items.filter('#preview').children());
          var show_preview = preview.children().length != 0;
          $("#ticketchange").toggle(show_preview);
          setRevertHandler();
          // Collapse property form if comment editor has focus
          if (show_preview && comment_focused)
            $("#modify").parent().addClass("collapsed");
          // Execute scripts to load stylesheets
          items.filter("script").appendTo("head");
        }, "#ticketchange .trac-loading");
        $("#trac-comment-editor").autoSubmit({preview_comment: '1'}, function(data, reply) {
          var comment = $("#trac-comment-editor").next("div.comment").html(reply);
          comment.toggle(comment.children().length != 0);
        }, "#changelog .trac-loading");
        /*]]>*/
      });
    </script>
    <!--[if lte IE 8]>
        <link rel="stylesheet" href="${href.chrome('site/css/output-ie.css')}" />
     <![endif]-->
    <!--[if gt IE 8]><!-->
        <link rel="stylesheet" href="/chrome/site/css/output.css" />
    <!--<![endif]-->
    <link rel="stylesheet" href="/chrome/site/css/trachacks.css" />
    <script src="//ajax.googleapis.com/ajax/libs/webfont/1.5.6/webfont.js"></script>
    <script>
    WebFont.load({
        google: {
            families: ['Inconsolata:400,700:latin', 'Roboto:400italic,700italic,300,700,400:latin']
        }
    });
    </script>
    <script src="/chrome/site/js/lib/modernizr.js"></script>
      <script type="text/javascript" src="/chrome/site/tickethacks.js"></script>
  </head>
  <body id="generic">
    <div role="banner" id="top">
      <div class="container">
        <a class="logo" href="https://www.djangoproject.com/">Django</a>
        <p class="meta">The web framework for perfectionists with deadlines.</p>
        <nav role="navigation">
          <ul>
            <li><a href="https://www.djangoproject.com/">Overview</a></li>
            <li><a href="https://www.djangoproject.com/download/">Download</a></li>
            <li><a href="https://docs.djangoproject.com/">Documentation</a></li>
            <li><a href="https://www.djangoproject.com/weblog/">News</a></li>
            <li><a href="https://www.djangoproject.com/community/">Community</a></li>
            <li class="active"><a href="/">Code</a></li>
            <li><a href="https://www.djangoproject.com/foundation/">About</a></li>
            <li><a href="https://www.djangoproject.com/fundraising/">♥ Donate</a></li>
          </ul>
        </nav>
      </div>
    </div>
    <div class="copy-banner">
      <div class="container">
        <h1>Code</h1>
      </div>
    </div>
      <div class="container full-width">
        <div role="main">
          <div id="metanav" class="nav">
    <ul>
      <li class="first"><a href="/github/login">GitHub Login</a></li><li><a href="/login">DjangoProject Login</a></li><li><a href="/prefs">Preferences</a></li><li class="last"><a href="/rpc">API</a></li>
    </ul>
  </div>
          <div id="mainnav" class="nav">
    <ul>
      <li class="first active"><a href="/query">View Tickets</a></li><li><a href="/wiki/Reports">Reports</a></li><li><a href="/timeline">Timeline</a></li><li><a href="/wiki">Wiki</a></li><li class="last"><a href="/search">Search</a></li>
    </ul>
  </div>
          <div id="main">
      <div id="ctxtnav" class="nav">
        <h2>Context Navigation</h2>
        <ul>
          <li class="first"><span>&larr; <a class="prev" href="/ticket/25474" title="Ticket #25474">Previous Ticket</a></span></li><li class="last"><span><a class="next" href="/ticket/25476" title="Ticket #25476">Next Ticket</a> &rarr;</span></li>
        </ul>
        <hr />
      </div>
    <div id="content" class="ticket">
        <div id="ticket" class="trac-content ">
  <div class="date">
    <p>Opened <a class="timeline" href="/timeline?from=2015-09-27T00%3A37%3A44-05%3A00&amp;precision=second" title="See timeline at 09/27/15 00:37:44">6 months ago</a></p>
    <p>Last modified <a class="timeline" href="/timeline?from=2015-10-17T18%3A33%3A44-05%3A00&amp;precision=second" title="See timeline at 10/17/15 18:33:44">5 months ago</a></p>
  </div>
  <h2>
    <a href="/ticket/25475" class="trac-id">#25475</a>
    <span class="trac-status">
      <a href="/query?status=new">new</a>
    </span>
    <span class="trac-type">
      <a href="/query?status=!closed&amp;type=Cleanup%2Foptimization">Cleanup/optimization</a>
    </span>
  </h2>
  <h1 id="trac-ticket-title" class="searchable">
    <span class="summary">Database function strftime with argument %W fails in 1.9a1</span>
  </h1>
  <table class="properties">
    <tr>
      <th id="h_reporter">Reported by:</th>
      <td headers="h_reporter" class="searchable"><a href="/query?status=!closed&amp;reporter=vtbassmatt">vtbassmatt</a></td>
      <th id="h_owner">Owned by:</th>
      <td headers="h_owner"><a href="/query?status=!closed&amp;owner=nobody">nobody</a></td>
    </tr>
    <tr>
        <th id="h_component">
          Component:
        </th>
        <td headers="h_component">
              <a href="/query?status=!closed&amp;component=Documentation">Documentation</a>
        </td>
        <th id="h_version">
          Version:
        </th>
        <td headers="h_version">
              <a href="/query?status=!closed&amp;version=1.8">1.8</a>
        </td>
    </tr><tr>
        <th id="h_severity">
          Severity:
        </th>
        <td headers="h_severity">
              <a href="/query?status=!closed&amp;severity=Normal">Normal</a>
        </td>
        <th id="h_keywords">
          Keywords:
        </th>
        <td headers="h_keywords" class="searchable">
              <a href="/query?status=!closed&amp;keywords=~func">func</a> <a href="/query?status=!closed&amp;keywords=~strftime">strftime</a>
        </td>
    </tr><tr>
        <th id="h_cc">
          Cc:
        </th>
        <td headers="h_cc" class="searchable">
              josh.smeaton@…
        </td>
        <th id="h_stage">
          Triage Stage:
        </th>
        <td headers="h_stage">
              <a href="/query?status=!closed&amp;stage=Accepted">Accepted</a>
        </td>
    </tr><tr>
        <th id="h_has_patch">
          Has patch:
        </th>
        <td headers="h_has_patch">
              <a href="/query?status=!closed&amp;has_patch=0">no</a>
        </td>
        <th id="h_needs_docs">
          Needs documentation:
        </th>
        <td headers="h_needs_docs">
              <a href="/query?status=!closed&amp;needs_docs=0">no</a>
        </td>
    </tr><tr>
        <th id="h_needs_tests">
          Needs tests:
        </th>
        <td headers="h_needs_tests">
              <a href="/query?status=!closed&amp;needs_tests=0">no</a>
        </td>
        <th id="h_needs_better_patch">
          Patch needs improvement:
        </th>
        <td headers="h_needs_better_patch">
              <a href="/query?status=!closed&amp;needs_better_patch=0">no</a>
        </td>
    </tr><tr>
        <th id="h_easy">
          Easy pickings:
        </th>
        <td headers="h_easy">
              <a href="/query?status=!closed&amp;easy=0">no</a>
        </td>
        <th id="h_ui_ux">
          UI/UX:
        </th>
        <td headers="h_ui_ux">
              <a href="/query?status=!closed&amp;ui_ux=0">no</a>
        </td>
    </tr>
  </table>
  <div class="description">
    <h3 id="comment:description">
      Description
    </h3>
    <div class="searchable">
      <p>
I have a database function to annotate the week of a date. It worked in 1.8 but breaks in 1.9a1, failing with a "ValueError: unsupported format character 'W'" exception.<br />
</p>
<pre class="wiki">class Week(Func):
    function = 'strftime'
    template = "%(function)s('%%W',%(expressions)s)"

def data_last_n_weeks(user, week_count):
    assert week_count &gt; 0, "week_count must be greater than 0"
    assert week_count &lt; 52, "week_count must be less than 52"

    today = date.today()
    most_recent_monday = today - timedelta(days=(today.isoweekday()-1))
    start_date = most_recent_monday - timedelta(days=7*(week_count-1))

    data = user.serving_set.filter(date__range=(start_date, today)
            ).annotate(week=Week('date', output_field=IntegerField())).values(
            'week').annotate(amt=Sum('amount'), cost=Sum('cost'))

    return data
</pre><p>
yields<br />
</p>
<pre class="wiki">  File "/Users/[me]/Projects/[proj]/ENV/lib/python3.4/site-packages/django/db/backends/sqlite3/operations.py", line 133, in last_executed_query
    return sql % params
ValueError: unsupported format character 'W' (0x57) at index 18
</pre>
    </div>
  </div>
</div>
          
    <div id="attachments">
        <h3 class="foldable">Attachments <span class="trac-count">(1)</span></h3>
        <div class="attachments">
          <dl class="attachments">
              <dt>
    <a href="/attachment/ticket/25475/t25475.tar.gz" title="View attachment">t25475.tar.gz</a><a href="/raw-attachment/ticket/25475/t25475.tar.gz" class="trac-rawlink" title="Download">​</a>
       (<span title="1762 bytes">1.7 KB</span>) -
      added by <em>timgraham</em> <a class="timeline" href="/timeline?from=2015-10-02T07%3A07%3A47-05%3A00&amp;precision=second" title="See timeline at 10/02/15 07:07:47">6 months ago</a>.
  </dt>
          </dl>
          <p>
            Download all attachments as: <a rel="nofollow" href="/zip-attachment/ticket/25475/">.zip</a>
          </p>
          
        </div>
    </div>

        <div>
          <div style="position: relative">
            <form id="prefs" method="get" action="/prefs" style="position: absolute; right: 0">
              <div id="trac-comments-order">
                <input type="radio" id="trac-comments-oldest" name="trac-comments-order" value="oldest" checked="checked" />
                <label for="trac-comments-oldest">Oldest first</label>
                <input type="radio" id="trac-comments-newest" name="trac-comments-order" value="newest" />
                <label for="trac-comments-newest">Newest first</label>
                <span id="trac-threaded-toggle" style="display: none">
                  <input type="radio" id="trac-comments-threaded" name="trac-comments-order" value="threaded" />
                  <label for="trac-comments-threaded">Threaded</label>
                </span>
              </div>
              <div>
                <input id="trac-comments-only-toggle" type="checkbox" />
                <label for="trac-comments-only-toggle">Comments only</label>
              </div>
            </form>
          </div>
          <h3 class="foldable">Change History <span class="trac-count">(19)</span></h3>
          <div id="changelog">
              <div class="change" id="trac-change-1-1443332314975249">
                
  <h3 class="change">
    <span class="threading">
      <span id="comment:1" class="cnum">
    <a href="#comment:1">comment:1</a>
  </span>
    </span>
        Changed <a class="timeline" href="/timeline?from=2015-09-27T00%3A38%3A34-05%3A00&amp;precision=second" title="See timeline at 09/27/15 00:38:34">6 months ago</a> by vtbassmatt
  </h3>
  <div class="trac-ticket-buttons">
  </div>
  <ul class="changes">
    <li class="trac-field-needs_docs">
      <strong class="trac-field-needs_docs">Needs documentation</strong>
        unset
    </li><li class="trac-field-needs_tests">
      <strong class="trac-field-needs_tests">Needs tests</strong>
        unset
    </li><li class="trac-field-needs_better_patch">
      <strong class="trac-field-needs_better_patch">Patch needs improvement</strong>
        unset
    </li><li class="trac-field-summary">
      <strong class="trac-field-summary">Summary</strong>
        changed from <em>Database function srtftime with argument %W fails in 1.9a1</em> to <em>Database function strftime with argument %W fails in 1.9a1</em>
    </li>
  </ul>

              </div>
              <div class="change" id="trac-change-2-1443335733494879">
                
  <h3 class="change">
    <span class="threading">
      <span id="comment:2" class="cnum">
    <a href="#comment:2">comment:2</a>
  </span>
    </span>
        Changed <a class="timeline" href="/timeline?from=2015-09-27T01%3A35%3A33-05%3A00&amp;precision=second" title="See timeline at 09/27/15 01:35:33">6 months ago</a> by aaugustin
  </h3>
  <div class="trac-ticket-buttons">
  </div>
    <div class="comment searchable">
      <p>
I think we need to re-escape % after executing <tt>template % self.extra</tt> in <tt>Func.as_sql</tt>.<br />
</p>

    </div>

              </div>
              <div class="change" id="trac-change-3-1443377467764753">
                
  <h3 class="change">
    <span class="threading">
      <span id="comment:3" class="cnum">
    <a href="#comment:3">comment:3</a>
  </span>
    </span>
        Changed <a class="timeline" href="/timeline?from=2015-09-27T13%3A11%3A07-05%3A00&amp;precision=second" title="See timeline at 09/27/15 13:11:07">6 months ago</a> by claudep
  </h3>
  <div class="trac-ticket-buttons">
  </div>
  <ul class="changes">
    <li class="trac-field-severity">
      <strong class="trac-field-severity">Severity</strong>
        changed from <em>Normal</em> to <em>Release blocker</em>
    </li><li class="trac-field-stage">
      <strong class="trac-field-stage">Triage Stage</strong>
        changed from <em>Unreviewed</em> to <em>Accepted</em>
    </li>
  </ul>

              </div>
              <div class="change" id="trac-change-4-1443708922205024">
                
  <h3 class="change">
    <span class="threading">
      <span id="comment:4" class="cnum">
    <a href="#comment:4">comment:4</a>
  </span>
    </span>
        Changed <a class="timeline" href="/timeline?from=2015-10-01T09%3A15%3A22-05%3A00&amp;precision=second" title="See timeline at 10/01/15 09:15:22">6 months ago</a> by timgraham
  </h3>
  <div class="trac-ticket-buttons">
  </div>
    <div class="comment searchable">
      <p>
I'm having trouble getting the database function you provided working on 1.8. Am I doing something wrong? I tried <tt>Poll.objects.annotate(week=Week('pub_date', output_field=models.IntegerField())</tt>.<br />
</p>
<p>
This gives:<br />
</p>
<pre class="wiki">  File "/home/tim/code/django/django/db/backends/utils.py", line 66, in execute
    return self.cursor.execute(sql, params)
IndexError: tuple index out of range
</pre><p>
with <tt>sql</tt> and <tt>params</tt>:<br />
<tt>SELECT "polls_poll"."id", "polls_poll"."question", "polls_poll"."pub_date", "polls_poll"."amount", "polls_poll"."cost", strftime('%W',"polls_poll"."pub_date") AS "week" FROM "polls_poll" LIMIT 21</tt><br />
<tt>()</tt>.<br />
</p>

    </div>

              </div>
              <div class="change" id="trac-change-5-1443720848035196">
                
  <h3 class="change">
    <span class="threading">
      <span id="comment:5" class="cnum">
    <a href="#comment:5">comment:5</a>
  </span>
    </span>
        Changed <a class="timeline" href="/timeline?from=2015-10-01T12%3A34%3A08-05%3A00&amp;precision=second" title="See timeline at 10/01/15 12:34:08">6 months ago</a> by vtbassmatt
  </h3>
  <div class="trac-ticket-buttons">
  </div>
    <div class="comment searchable">
      <p>
I don't see anything wrong with the simplified case you wrote. I'm not in a place where I can generate the sql from my repro but I'll get it tonight.<br />
</p>
<p>
One possible difference is that Serving.date is a DateField while I suspect Poll.pub_date is a DateTimeField. That could matter.<br />
</p>
<p>
Also, I've only tested with SQLite - possible that this is database dependent?<br />
</p>

    </div>

              </div>
              <div class="change" id="trac-change-6-1443724726544789">
                
  <h3 class="change">
    <span class="threading">
      <span id="comment:6" class="cnum">
    <a href="#comment:6">comment:6</a>
  </span>
    </span>
        Changed <a class="timeline" href="/timeline?from=2015-10-01T13%3A38%3A46-05%3A00&amp;precision=second" title="See timeline at 10/01/15 13:38:46">6 months ago</a> by aaugustin
  </h3>
  <div class="trac-ticket-buttons">
  </div>
    <div class="comment searchable">
      <p>
Looking at the excerpt of the stack trace you posted I'm pretty sure it only happens on SQLite.<br />
</p>

    </div>

              </div>
              <div class="change" id="trac-change-7-1443756051150348">
                
  <h3 class="change">
    <span class="threading">
      <span id="comment:7" class="cnum">
    <a href="#comment:7">comment:7</a>
  </span>
    </span>
        Changed <a class="timeline" href="/timeline?from=2015-10-01T22%3A20%3A51-05%3A00&amp;precision=second" title="See timeline at 10/01/15 22:20:51">6 months ago</a> by vtbassmatt
  </h3>
  <div class="trac-ticket-buttons">
  </div>
    <div class="comment searchable">
      <p>
I couldn't repro the IndexError in my setup. Here are two execution logs, one on 1.8.4 and the other on 1.9.0a1 using the exact same code and (a copy of) the exact same database. This time I haven't manually doctored the output for simplification as I did earlier.<br />
</p>
<p>
1.8.4:<br />
</p>
<pre class="wiki">(3NV) mattc ~/Projects/beer30/beersite $ ./manage.py shell
Python 3.4.2 (default, Oct 19 2014, 12:51:48) 
[GCC 4.2.1 Compatible Apple LLVM 6.0 (clang-600.0.54)] on darwin
Type "help", "copyright", "credits" or "license" for more information.
(InteractiveConsole)
&gt;&gt;&gt; from django.contrib.auth.models import User
&gt;&gt;&gt; from api.views import beer_data_last_n_weeks
&gt;&gt;&gt; u = User.objects.get(pk=1)
&gt;&gt;&gt; beer_data_last_n_weeks(u, 5)
[{'cost': Decimal('41.00'), 'week': 35, 'oz': Decimal('228.0')}, {'cost': Decimal('41.50'), 'week': 36, 'oz': Decimal('158.0')}, {'cost': Decimal('28.93'), 'week': 37, 'oz': Decimal('198.6')}, {'cost': Decimal('24.66'), 'week': 38, 'oz': Decimal('128.0')}, {'cost': Decimal('3.33'), 'week': 39, 'oz': Decimal('12.0')}]
</pre><p>
1.9.0a1:<br />
</p>
<pre class="wiki">(3NV) mattc ~/Projects/beer31/beersite $ ./manage.py shell
Python 3.4.3 (default, Aug 11 2015, 08:57:25) 
[GCC 4.2.1 Compatible Apple LLVM 6.1.0 (clang-602.0.53)] on darwin
Type "help", "copyright", "credits" or "license" for more information.
(InteractiveConsole)
&gt;&gt;&gt; from django.contrib.auth.models import User
&gt;&gt;&gt; from api.views import beer_data_last_n_weeks
&gt;&gt;&gt; u = User.objects.get(pk=1)
&gt;&gt;&gt; beer_data_last_n_weeks(u, 5)
Traceback (most recent call last):
  File "&lt;console&gt;", line 1, in &lt;module&gt;
  File "/Users/mattc/Projects/beer31/3NV/lib/python3.4/site-packages/django/db/models/query.py", line 234, in __repr__
    data = list(self[:REPR_OUTPUT_SIZE + 1])
  File "/Users/mattc/Projects/beer31/3NV/lib/python3.4/site-packages/django/db/models/query.py", line 258, in __iter__
    self._fetch_all()
  File "/Users/mattc/Projects/beer31/3NV/lib/python3.4/site-packages/django/db/models/query.py", line 1074, in _fetch_all
    self._result_cache = list(self.iterator())
  File "/Users/mattc/Projects/beer31/3NV/lib/python3.4/site-packages/django/db/models/query.py", line 112, in __iter__
    for row in compiler.results_iter():
  File "/Users/mattc/Projects/beer31/3NV/lib/python3.4/site-packages/django/db/models/sql/compiler.py", line 806, in results_iter
    results = self.execute_sql(MULTI)
  File "/Users/mattc/Projects/beer31/3NV/lib/python3.4/site-packages/django/db/models/sql/compiler.py", line 852, in execute_sql
    cursor.execute(sql, params)
  File "/Users/mattc/Projects/beer31/3NV/lib/python3.4/site-packages/django/db/backends/utils.py", line 83, in execute
    sql = self.db.ops.last_executed_query(self.cursor, sql, params)
  File "/Users/mattc/Projects/beer31/3NV/lib/python3.4/site-packages/django/db/backends/sqlite3/operations.py", line 133, in last_executed_query
    return sql % params
ValueError: unsupported format character 'W' (0x57) at index 18
</pre><p>
Relevant code snippets:<br />
</p>
<p>
api/views.py<br />
</p>
<pre class="wiki">class Week(Func):
    function = 'strftime'
    template = "%(function)s('%%W',%(expressions)s)"


def beer_data_last_n_weeks(user, week_count):
    assert week_count &gt; 0, "week_count must be greater than 0"
    assert week_count &lt; 52, "week_count must be less than 52"

    today = date.today()
    most_recent_monday = today - timedelta(days=(today.isoweekday()-1))
    start_date = most_recent_monday - timedelta(days=7*(week_count-1))

    beer_data = user.serving_set.filter(date__range=(start_date, today)
            ).annotate(week=Week('date', output_field=IntegerField())).values(
            'week').annotate(oz=Sum('amount'), cost=Sum('cost'))

    return beer_data
</pre><p>
datamodel/models.py<br />
</p>
<pre class="wiki">class Serving(models.Model):
    SERVING_CHOICES = (
        (0, "unknown"),
        (1, "tap"),
        (2, "bottle"),
        (4, "can"),
        (3, "growler"),
    )
    beer = models.ForeignKey(Beer)
    amount = models.DecimalField(max_digits=4, decimal_places=1)
    date = models.DateField()
    type = models.SmallIntegerField(choices=SERVING_CHOICES, default=1)
    owner = models.ForeignKey(User)
    location = models.CharField(max_length=100, blank=True)
    cost = models.DecimalField(max_digits=5,
                               decimal_places=2, null=True, blank=True)

    def __str__(self):
        return " ".join([str(self.amount), "oz of", self.beer.name])
</pre>
    </div>

              </div>
              <div class="change" id="trac-change-8-1443787644475567">
                
  <h3 class="change">
    <span class="threading">
      <span id="comment:8" class="cnum">
    <a href="#comment:8">comment:8</a>
  </span>
    </span>
        Changed <a class="timeline" href="/timeline?from=2015-10-02T07%3A07%3A24-05%3A00&amp;precision=second" title="See timeline at 10/02/15 07:07:24">6 months ago</a> by timgraham
  </h3>
  <div class="trac-ticket-buttons">
  </div>
    <div class="comment searchable">
      <p>
I'm attaching a sample app based on the models you provided (I removed the foreign key to <tt>Beer</tt> since you didn't provide that model), however, the test works without error for me. Does it work for you? If so, could you say how to modify it to reproduce the error? If not, then perhaps it's something like a difference between versions of SQLite.<br />
</p>
<p>
System details: <br />
Python 3.4.3 (default, Mar  5 2015, 15:15:09) <br />
[GCC 4.8.2] on linux<br />
sqlite3 2.6.0<br />
</p>

    </div>

              </div>
              <div class="change">
                
  <h3 class="change">
    <span class="threading">
    </span>
        Changed <a class="timeline" href="/timeline?from=2015-10-02T07%3A07%3A47-05%3A00&amp;precision=second" title="See timeline at 10/02/15 07:07:47">6 months ago</a> by timgraham
  </h3>
  <div class="trac-ticket-buttons">
  </div>
  <ul class="changes">
    <li class="trac-field-attachment">
      <strong class="trac-field-attachment">Attachment</strong>
        <a href="/attachment/ticket/25475/t25475.tar.gz"><em>t25475.tar.gz</em></a><a href="/raw-attachment/ticket/25475/t25475.tar.gz" title="Download" class="trac-rawlink">​</a>
          added
    </li>
  </ul>

              </div>
              <div class="change" id="trac-change-9-1443803413136033">
                
  <h3 class="change">
    <span class="threading">
      <span id="comment:9" class="cnum">
    <a href="#comment:9">comment:9</a>
  </span>
    </span>
        Changed <a class="timeline" href="/timeline?from=2015-10-02T11%3A30%3A13-05%3A00&amp;precision=second" title="See timeline at 10/02/15 11:30:13">6 months ago</a> by vtbassmatt
  </h3>
  <div class="trac-ticket-buttons">
  </div>
    <div class="comment searchable">
      <p>
Your test case does not fail on the Windows machine I currently have available (Windows 10.0.10240 with SQLite3 2.6.0, sqlite3.sqlite_version 3.8.3.1). Will check on my Mac later tonight - that's where I've observed the failure.<br />
</p>
<p>
From looking at Apple's online man pages, 3.1.3 is shown in the sample outputs.<br />
</p>

    </div>

              </div>
              <div class="change" id="trac-change-10-1443830247542174">
                
  <h3 class="change">
    <span class="threading">
      <span id="comment:10" class="cnum">
    <a href="#comment:10">comment:10</a>
  </span>
    </span>
        Changed <a class="timeline" href="/timeline?from=2015-10-02T18%3A57%3A27-05%3A00&amp;precision=second" title="See timeline at 10/02/15 18:57:27">6 months ago</a> by vtbassmatt
  </h3>
  <div class="trac-ticket-buttons">
  </div>
    <div class="comment searchable">
      <p>
Argh, that test case doesn't fail on my Mac either. The real app still exhibits the behavior, so I'll keep digging and see what it takes to make the test case fail.<br />
</p>

    </div>

              </div>
              <div class="change" id="trac-change-11-1443833955742141">
                
  <h3 class="change">
    <span class="threading">
      <span id="comment:11" class="cnum">
    <a href="#comment:11">comment:11</a>
  </span>
    </span>
        Changed <a class="timeline" href="/timeline?from=2015-10-02T19%3A59%3A15-05%3A00&amp;precision=second" title="See timeline at 10/02/15 19:59:15">6 months ago</a> by vtbassmatt
  </h3>
  <div class="trac-ticket-buttons">
  </div>
    <div class="comment searchable">
      <p>
I'm so sorry. Somewhere between my full app and your test case there's a cutover point where this starts failing on 1.9a1, but I can't find it. I've learned quite a bit more about Pdb tonight than I really intended but to no avail.<br />
</p>
<p>
1.8 and 1.9 both accept a double-escaped percent sign, so I'm going to update my code to that.<br />
</p>
<pre class="wiki">class Week(Func):
    function = 'strftime'
    template = "%(function)s('%%%%W',%(expressions)s)"
</pre><p>
I'd be happy to share the whole project with someone from the core team if it would help further debugging.<br />
</p>

    </div>

              </div>
              <div class="change" id="trac-change-12-1443835079499440">
                
  <h3 class="change">
    <span class="threading">
      <span id="comment:12" class="cnum">
    <a href="#comment:12">comment:12</a>
  </span>
    </span>
        Changed <a class="timeline" href="/timeline?from=2015-10-02T20%3A17%3A59-05%3A00&amp;precision=second" title="See timeline at 10/02/15 20:17:59">5 months ago</a> by jarshwah
  </h3>
  <div class="trac-ticket-buttons">
  </div>
  <ul class="changes">
    <li class="trac-field-cc">
      <strong class="trac-field-cc">Cc</strong>
        <em>josh.smeaton@…</em> added
    </li>
  </ul>

              </div>
              <div class="change" id="trac-change-13-1443881049267574">
                
  <h3 class="change">
    <span class="threading">
      <span id="comment:13" class="cnum">
    <a href="#comment:13">comment:13</a>
  </span>
    </span>
        Changed <a class="timeline" href="/timeline?from=2015-10-03T09%3A04%3A09-05%3A00&amp;precision=second" title="See timeline at 10/03/15 09:04:09">5 months ago</a> by timgraham
  </h3>
  <div class="trac-ticket-buttons">
  </div>
    <div class="comment searchable">
      <p>
If you could <a class="ext-link" href="https://docs.djangoproject.com/en/dev/internals/contributing/triaging-tickets/#bisecting-a-regression"><span class="icon">​</span>use git bisect</a> to find the commit where the behavior changed, that might yield some insight.<br />
</p>

    </div>

              </div>
              <div class="change" id="trac-change-14-1443892570624762">
                
  <h3 class="change">
    <span class="threading">
      <span id="comment:14" class="cnum">
    <a href="#comment:14">comment:14</a>
  </span>
    </span>
        Changed <a class="timeline" href="/timeline?from=2015-10-03T12%3A16%3A10-05%3A00&amp;precision=second" title="See timeline at 10/03/15 12:16:10">5 months ago</a> by aaugustin
  </h3>
  <div class="trac-ticket-buttons">
  </div>
    <div class="comment searchable">
      <p>
The exception is triggered in code I added in <a class="changeset" href="/changeset/4f6a7663" title="Refs #14091 -- Fixed connection.queries on SQLite.">[4f6a7663]</a>. However it's unclear to me why this code would be incorrect.<br />
</p>

    </div>

              </div>
              <div class="change" id="trac-change-15-1443895697991461">
                
  <h3 class="change">
    <span class="threading">
      <span id="comment:15" class="cnum">
    <a href="#comment:15">comment:15</a>
  </span>
    </span>
        Changed <a class="timeline" href="/timeline?from=2015-10-03T13%3A08%3A17-05%3A00&amp;precision=second" title="See timeline at 10/03/15 13:08:17">5 months ago</a> by claudep
  </h3>
  <div class="trac-ticket-buttons">
  </div>
    <div class="comment searchable">
      <p>
It may be because <tt>_quote_params_for_last_executed_query</tt> is bypassing the Django cursor wrapper. When the wrapper is executing a query, it takes care of not passing <tt>params</tt> when it is None. Maybe we should do the same dance in  <tt>_quote_params_for_last_executed_query</tt>.<br />
</p>

    </div>

              </div>
              <div class="change" id="trac-change-16-1444764331504730">
                
  <h3 class="change">
    <span class="threading">
      <span id="comment:16" class="cnum">
    <a href="#comment:16">comment:16</a>
  </span>
    </span>
        Changed <a class="timeline" href="/timeline?from=2015-10-13T14%3A25%3A31-05%3A00&amp;precision=second" title="See timeline at 10/13/15 14:25:31">5 months ago</a> by claudep
  </h3>
  <div class="trac-ticket-buttons">
  </div>
    <div class="comment searchable">
      <p>
I think the bug is rather that the initial version didn't break in 1.8! You implicitly counted on the fact the the sqlite driver accepts the following query (2 placeholder-like occurrences, one param):<br />
</p>
<pre class="wiki">cursor.execute("SELECT strftime('%W', 'date') WHERE 42=%s", (42,))
</pre><p>
It may be because the SQLite driver only recognizes the <tt>%s</tt> placeholder (a guess). A similar query with MySQL and DATE_FORMAT by example would produce an error.<br />
</p>
<p>
We might fix the bug by a documentation note somewhere in custom expressions.<br />
</p>

    </div>

              </div>
              <div class="change" id="trac-change-17-1444766093066311">
                
  <h3 class="change">
    <span class="threading">
      <span id="comment:17" class="cnum">
    <a href="#comment:17">comment:17</a>
  </span>
    </span>
        Changed <a class="timeline" href="/timeline?from=2015-10-13T14%3A54%3A53-05%3A00&amp;precision=second" title="See timeline at 10/13/15 14:54:53">5 months ago</a> by vtbassmatt
  </h3>
  <div class="trac-ticket-buttons">
  </div>
    <div class="comment searchable">
      <p>
Totally fair, I probably misunderstood the docs :)<br />
</p>
<p>
So I should have double-escaped to begin with? In retrospect that makes sense. If you guys want to doc that and close this issue, I'm good with that.<br />
</p>
<pre class="wiki">class Week(Func):
    function = 'strftime'
    template = "%(function)s('%%%%W',%(expressions)s)"
</pre>
    </div>

              </div>
              <div class="change" id="trac-change-18-1445124824418615">
                
  <h3 class="change">
    <span class="threading">
      <span id="comment:18" class="cnum">
    <a href="#comment:18">comment:18</a>
  </span>
    </span>
        Changed <a class="timeline" href="/timeline?from=2015-10-17T18%3A33%3A44-05%3A00&amp;precision=second" title="See timeline at 10/17/15 18:33:44">5 months ago</a> by timgraham
  </h3>
  <div class="trac-ticket-buttons">
  </div>
  <ul class="changes">
    <li class="trac-field-component">
      <strong class="trac-field-component">Component</strong>
        changed from <em>Database layer (models, ORM)</em> to <em>Documentation</em>
    </li><li class="trac-field-severity">
      <strong class="trac-field-severity">Severity</strong>
        changed from <em>Release blocker</em> to <em>Normal</em>
    </li><li class="trac-field-type">
      <strong class="trac-field-type">Type</strong>
        changed from <em>Bug</em> to <em>Cleanup/optimization</em>
    </li><li class="trac-field-version">
      <strong class="trac-field-version">Version</strong>
        changed from <em>1.9a1</em> to <em>1.8</em>
    </li>
  </ul>

              </div>
          </div>
        </div>
      <div id="help"><strong>Note:</strong> See
        <a href="/wiki/TracTickets">TracTickets</a> for help on using
        tickets.</div>
    </div>
    <div id="altlinks">
      <h3>Download in other formats:</h3>
      <ul>
        <li class="first">
          <a rel="nofollow" href="/ticket/25475?format=csv" class="csv">Comma-delimited Text</a>
        </li><li>
          <a rel="nofollow" href="/ticket/25475?format=tab" class="tab">Tab-delimited Text</a>
        </li><li class="last">
          <a rel="nofollow" href="/ticket/25475?format=rss" class="rss">RSS Feed</a>
        </li>
      </ul>
    </div>
    </div>
          <a href="#top" class="backtotop"><i class="icon icon-chevron-up"></i> Back to Top</a>
        </div>
      </div>
    <div role="contentinfo">
      <div class="subfooter">
        <div class="container">
          <h1 class="visuallyhidden">Django Links</h1>
          <div class="col learn">
            <h2>Learn More</h2>
            <ul>
              <li><a href="https://www.djangoproject.com/overview/">About Django</a></li>
              <li><a href="https://www.djangoproject.com/start/">Getting Started with Django</a></li>
              <li><a href="https://www.djangoproject.com/foundation/">Django Software Foundation</a></li>
              <li><a href="https://www.djangoproject.com/conduct/">Code of Conduct</a></li>
            </ul>
          </div>
          <div class="col involved">
            <h2>Get Involved</h2>
            <ul>
              <li><a href="https://www.djangoproject.com/community/">Join a Group</a></li>
              <li><a href="https://docs.djangoproject.com/en/dev/internals/contributing/">Contribute to Django</a></li>
              <li><a href="https://docs.djangoproject.com/en/dev/internals/contributing/bugs-and-features/#reporting-security-issues">Submit a Bug</a></li>
              <li><a href="https://docs.djangoproject.com/en/dev/internals/security/">Report a Security Issue</a></li>
            </ul>
          </div>
          <div class="col follow">
            <h2>Follow Us</h2>
            <ul>
              <li><a href="http://github.com/django">GitHub</a></li>
              <li><a href="https://twitter.com/djangoproject">Twitter</a></li>
              <li><a href="https://www.djangoproject.com/rss/weblog/">News RSS</a></li>
              <li><a href="https://groups.google.com/forum/#!forum/django-users">Django Users Mailing List</a></li>
            </ul>
          </div>
        </div>
      </div>
      <div class="footer">
        <div class="container">
          <div class="footer-logo">
            <a class="logo" href="https://djangoproject.com/">Django</a>
          </div>
          <ul class="thanks">
            <li><span>Hosting by</span> <a class="rackspace" href="http://rackspace.com">Rackspace</a></li>
            <li class="design"><span>Design by</span> <a class="threespot" href="http://www.threespot.com">Threespot</a> <span class="ampersand">&amp;</span> <a class="andrevv" href="http://andrevv.com/"></a></li>
          </ul>
          <p class="copyright">© 2005-2016
              <a href="https://djangoproject.com/foundation/"> Django Software
              Foundation</a> unless otherwise noted. Django is a
              <a href="https://djangoproject.com/trademarks/">registered
              trademark</a> of the Django Software Foundation.
          </p>
        </div>
      </div>
    </div>
  <script data-main="/chrome/site/js/main.js" src="/chrome/site/js/lib/require.js"></script>
  </body>
</html>